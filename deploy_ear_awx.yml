- name: Download and Deploy EAR to WebSphere
  hosts: 10.112.30.40
  become: yes

  vars:
    jenkins_user: "{{ jenkins_user }}"
    jenkins_token: "{{ jenkins_token }}"
    docker_container_name: "emmis-t6"
    wsadmin_path: "/opt/IBM/WebSphere/AppServer_Emmis/profiles/AppSrv01_eMMIS/bin/wsadmin.sh"
    
    ear_name: "medicaid_EAR6.ear"  # You can override this in AWX Job Template
    ear_url: "http://mdcmwp-jenkins.mcd.ifox.loc:8080/job/eMMIS-DXCD/lastSuccessfulBuild/artifact/builds/{{ ear_name }}"
    ear_dest_path: "/opt/WAS/ear/{{ ear_name }}"

  tasks:
    - name: Ensure EAR destination directory exists
      file:
        path: "/opt/WAS/ear"
        state: directory
        mode: '0755'

    - name: Download EAR file from Jenkins
      get_url:
        url: "{{ ear_url }}"
        dest: "{{ ear_dest_path }}"
        url_username: "{{ jenkins_user }}"
        url_password: "{{ jenkins_token }}"
        force_basic_auth: yes
        mode: '0644'

    - name: Deploy EAR inside Docker container using wsadmin
      command: >
        docker exec {{ docker_container_name }}
        {{ wsadmin_path }}
        -lang jython -f /opt/WAS/scripts/deploy_was_script.py {{ ear_dest_path }}
